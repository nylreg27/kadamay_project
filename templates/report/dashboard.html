{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 mt-8 lg:mt-4"> {# Adjusted mt for fixed header #}
    <h1 class="text-3xl font-bold mb-6 text-base-content">{{ title }}</h1>

    <div class="mb-6 flex flex-col md:flex-row items-start md:items-center gap-4">
        <form action="{% url 'report:dashboard' %}" method="get" class="flex flex-col md:flex-row items-start md:items-center gap-2 w-full">
            <label for="church-select" class="text-lg font-medium whitespace-nowrap">Filter by Church:</label>
            <select name="church" id="church-select" class="select select-bordered w-full md:w-auto flex-grow" onchange="this.form.submit()">
                <option value="">All Churches</option>
                {% for church_obj in churches %}
                <option value="{{ church_obj.id }}" {% if selected_church|stringformat:"s" == church_obj.id|stringformat:"s" %}selected{% endif %}>
                    {{ church_obj.name }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary w-full md:w-auto">Apply Filter</button>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stat shadow-lg bg-base-200 p-4 rounded-lg">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <div class="stat-title">Total Families</div>
            <div class="stat-value text-primary">{{ total_families }}</div>
            <div class="stat-desc">All registered families</div>
        </div>
        <div class="stat shadow-lg bg-base-200 p-4 rounded-lg">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 10 002 2h4a2 10 002-2V4a2 10 00-2-2h-4a2 10 00-2 2m0 10V6m0 4a2 10 002 2h4a2 10 002-2v-4a2 10 00-2-2h-4a2 10 00-2 2"></path></svg>
            </div>
            <div class="stat-title">Total Members</div>
            <div class="stat-value text-secondary">{{ total_members }}</div>
            <div class="stat-desc">Includes all individuals</div>
        </div>
        <div class="stat shadow-lg bg-base-200 p-4 rounded-lg">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 110-4h14a2 110 4M5 8v10a2 002 2h10a2 002-2V8m-9 4h4"></path></svg>
            </div>
            <div class="stat-title">Total Churches</div>
            <div class="stat-value text-accent">{{ total_churches }}</div>
            <div class="stat-desc">Active churches registered</div>
        </div>
        <div class="stat shadow-lg bg-base-200 p-4 rounded-lg">
            <div class="stat-figure text-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10m0 0h16m-4 0v-4m-3 0V7"></path></svg>
            </div>
            <div class="stat-title">Total Contributions</div>
            <div class="stat-value text-info">₱{{ total_contributions|floatformat:2 }}</div>
            <div class="stat-desc">Overall financial contributions</div>
        </div>
    </div>

    <div class="bg-base-200 shadow-lg rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-base-content">Membership Status Distribution</h2>
        <div class="h-64">
            <canvas id="membershipStatusChart"></canvas>
        </div>
    </div>

    <div class="bg-base-200 shadow-lg rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-base-content">Contributions Over Time</h2>
        <div class="h-64">
            <canvas id="contributionsChart"></canvas>
        </div>
    </div>

    <div class="bg-base-200 shadow-lg rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-base-content">Top 5 Families with Most Members</h2>
        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Family Name</th>
                        <th>Members Count</th>
                        <th>Church</th>
                    </tr>
                </thead>
                <tbody>
                    {% for family in top_families_by_members %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ family.family_name }}</td>
                        <td>{{ family.member_count }}</td>
                        <td>{{ family.church.name }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No families found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-base-200 shadow-lg rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-base-content">Top 5 Individual Contributors</h2>
        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Individual Name</th>
                        <th>Total Contribution</th>
                        <th>Church</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contributor in top_individual_contributors %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ contributor.full_name }}</td>
                        <td>₱{{ contributor.total_contribution|floatformat:2 }}</td>
                        <td>{{ contributor.family.church.name }}</td> {# assuming individual has family and family has church #}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No individual contributors found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-base-200 shadow-lg rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4 text-base-content">Church-wise Summary</h2>
        <div class="overflow-x-auto">
            <table class="table w-full">
                <thead>
                    <tr>
                        <th>Church Name</th>
                        <th>Total Families</th>
                        <th>Total Members</th>
                        <th>Total Contributions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for church_summary in church_summaries %}
                    <tr>
                        <td>{{ church_summary.name }}</td>
                        <td>{{ church_summary.total_families }}</td>
                        <td>{{ church_summary.total_members }}</td>
                        <td>₱{{ church_summary.total_contributions|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center">No church summaries found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Membership Status Chart
        var membershipCtx = document.getElementById('membershipStatusChart').getContext('2d');
        var membershipStatusChart = new Chart(membershipCtx, {
            type: 'pie',
            data: {
                // Gamita ang JSON-encoded data gikan sa Django context
                labels: Object.keys({{ membership_status_distribution_json|safe }}),
                datasets: [{
                    data: Object.values({{ membership_status_distribution_json|safe }}),
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)', // Active
                        'rgba(255, 99, 132, 0.6)', // Inactive
                        'rgba(255, 205, 86, 0.6)', // Pending
                        'rgba(54, 162, 235, 0.6)', // Other statuses if any
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(54, 162, 235, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        // Contributions Over Time Chart
        var contributionsCtx = document.getElementById('contributionsChart').getContext('2d');
        var contributionsChart = new Chart(contributionsCtx, {
            type: 'line',
            data: {
                // Gamita ang JSON-encoded data gikan sa Django context
                labels: {{ contributions_over_time_labels_json|safe }},
                datasets: [{
                    label: 'Total Contributions (₱)',
                    data: {{ contributions_over_time_data_json|safe }},
                    borderColor: 'rgba(153, 102, 255, 1)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Amount (₱)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '₱' + context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock content %}