{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-4 mt-8 lg:mt-4"> {# Adjusted mt for fixed header #}
    <h1 class="text-3xl font-bold mb-6 text-base-content">{{ title }}</h1>

    <div class="mb-6 flex flex-col md:flex-row items-start md:items-center gap-4">
        <form action="{% url 'report:dashboard' %}" method="get" class="flex flex-col md:flex-row items-start md:items-center gap-2 w-full">
            <label for="church-select" class="text-lg font-medium whitespace-nowrap">Filter by Church:</label>
            <select name="church" id="church-select" class="select select-bordered w-full md:w-auto flex-grow" onchange="this.form.submit()">
                <option value="">All Churches</option>
                {% for church_obj in churches %}
                <option value="{{ church_obj.id }}" {% if selected_church|safe == church_obj.id|stringformat:"s" %}selected{% endif %}>
                    {{ church_obj.name }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary w-full md:w-auto">Apply Filter</button>
        </form>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="card bg-primary text-primary-content shadow-md">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-xl"><i class="fas fa-church"></i> Total Churches</h2>
                <p class="text-4xl font-bold">{{ total_churches }}</p>
            </div>
        </div>
        <div class="card bg-success text-success-content shadow-md">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-xl"><i class="fas fa-users"></i> Total Families</h2>
                <p class="text-4xl font-bold">{{ total_families }}</p>
            </div>
        </div>
        <div class="card bg-info text-info-content shadow-md">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-xl"><i class="fas fa-user-friends"></i> Total Members</h2>
                <p class="text-4xl font-bold">{{ total_members }}</p>
            </div>
        </div>
        <div class="card bg-warning text-warning-content shadow-md">
            <div class="card-body items-center text-center">
                <h2 class="card-title text-xl"><i class="fas fa-hand-holding-usd"></i> Total Contributions</h2>
                <p class="text-4xl font-bold">â‚± {{ total_payments|floatformat:2 }}</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="lg:col-span-1">
            <div class="card bg-base-100 shadow-md h-full">
                <div class="card-header bg-base-200 text-base-content p-4 font-semibold rounded-t-lg">
                    Member Status
                </div>
                <ul class="menu p-4">
                    <li>
                        <div class="flex justify-between items-center px-2 py-1">
                            <span>Active Members</span>
                            <span class="badge badge-primary">{{ active_members }}</span>
                        </div>
                    </li>
                    <li>
                        <div class="flex justify-between items-center px-2 py-1">
                            <span>Inactive (Alive)</span>
                            <span class="badge badge-info">{{ inactive_alive }}</span>
                        </div>
                    </li>
                    <li>
                        <div class="flex justify-between items-center px-2 py-1">
                            <span>Deceased Members</span>
                            <span class="badge badge-neutral">{{ inactive_deceased }}</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-md h-full">
                <div class="card-header bg-base-200 text-base-content p-4 font-semibold rounded-t-lg">
                    Recent Members Added
                </div>
                <div class="card-body">
                    {% if recent_members %}
                    <ul class="menu p-4">
                        {% for member in recent_members %}
                        <li>
                            <a href="{% url 'individual:individual_detail' member.pk %}" class="flex justify-between items-center">
                                <span>{{ member.full_name }}</span>
                                <span class="badge badge-ghost">{{ member.date_added|date:"M d, Y" }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-center text-base-content/70">No recent members to display.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="card-body bg-white">
            <div class="card-header bg-base-200 text-base-content p-4 font-semibold rounded-t-lg">
                Families per Church
            </div>
            <div class="card-body">
                <canvas id="familyChart"></canvas>
                <p class="text-center mt-4 text-base-content/70" id="noFamilyDataMessage" style="display: none;">No family data available for churches.</p>
            </div>
        </div>
        <div class="card-body bg-white">
            <div class="card-header bg-base-200 text-base-content p-4 font-semibold rounded-t-lg">
                Monthly Contributions
            </div>
            <div class="card-body">
                <canvas id="monthlyContributionsChart"></canvas>
                <p class="text-center mt-4 text-base-content/70" id="noContributionsDataMessage" style="display: none;">No contribution data available for the last 12 months.</p>
            </div>
        </div>
    </div>

</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlDk+4Wv1I/c6B1vR0l40p/Q6E02n1Jm1q+a5K11s+j6+zQ/g+A/f/2t/W+a1P00P20S1B/g+tQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Define a set of fixed light-theme colors for charts
    const chartFixedColors = {
        primary: 'rgba(75, 192, 192, 1)', // A standard primary-like color for bars/lines
        accent: 'rgba(255, 99, 132, 1)', // A standard accent-like color for lines
        background: 'rgba(255, 255, 255, 1)', // White background
        labelColor: 'rgba(0, 0, 0, 0.8)', // Dark grey for labels/text
        gridColor: 'rgba(200, 200, 200, 0.5)', // Light grey for grid lines
        tooltipBackgroundColor: 'rgba(255, 255, 255, 0.9)', // White for tooltip background
        tooltipBorderColor: 'rgba(0, 0, 0, 0.2)', // Light border for tooltip
        tooltipLabelColor: 'rgba(0, 0, 0, 1)', // Black for tooltip text
    };

 // --- Families per Church Chart ---
 const churchNames = JSON.parse('{{ church_names|safe }}');
 const familyCounts = JSON.parse('{{ family_counts|safe }}');

 const familyChartCanvas = document.getElementById("familyChart");
 const noFamilyDataMessage = document.getElementById("noFamilyDataMessage");

 if (churchNames.length > 0 && familyCounts.length > 0) {
     new Chart(familyChartCanvas, {
         type: 'bar',
         data: {
             labels: churchNames,
             datasets: [{
                 label: 'Number of Families',
                 data: familyCounts,
                 backgroundColor: chartFixedColors.primary, // Fixed primary color
                 borderColor: chartFixedColors.primary,
                 borderWidth: 1
             }]
         },
         options: {
             responsive: true,
             maintainAspectRatio: false,
             scales: {
                 y: {
                     beginAtZero: true,
                     title: {
                         display: true,
                         text: 'Number of Families',
                         color: chartFixedColors.labelColor, // <-- ADDED COMMA HERE
                         font: {weight: 'bold' }// Bold label
                     },
                     ticks: {
                         callback: function(value) { if (value % 1 === 0) return value; },
                         color: chartFixedColors.labelColor, // <-- ADDED COMMA HERE
                         font: {weight: 'bold' }// Bold label
                     },
                     grid: {
                         color: chartFixedColors.gridColor // Fixed grid color
                         // No font property here as grid lines don't have text
                     }
                 },
                 x: {
                     title: {
                         display: true,
                         text: 'Church',
                         color: chartFixedColors.labelColor, // <-- ADDED COMMA HERE
                         font: {weight: 'bold' }// Bold label
                     },
                     ticks: {
                         color: chartFixedColors.labelColor, // Fixed tick color
                         maxRotation: 90, // Rotate labels by 90 degrees (vertical)
                         minRotation: 90,  // Ensure they are always rotated
                         //font: {weight: 'bold' }// <-- ADDED COMMA HERE for the `ticks` font property
                     },
                     grid: {
                         color: chartFixedColors.gridColor // Fixed grid color
                         // No font property here as grid lines don't have text
                     }
                 }
             },
             plugins: {
                 legend: {
                     display: false,
                     labels: {
                         color: chartFixedColors.labelColor, // <-- ADDED COMMA HERE
                         font: {weight: 'bold' }// Bold label
                     }
                 },
                 tooltip: {
                     backgroundColor: chartFixedColors.tooltipBackgroundColor, // Fixed tooltip background
                     borderColor: chartFixedColors.tooltipBorderColor, // Fixed tooltip border
                     borderWidth: 1,
                     titleColor: chartFixedColors.tooltipLabelColor, // Fixed tooltip title color
                     bodyColor: chartFixedColors.tooltipLabelColor, // Fixed tooltip body color
                     // The tooltip font properties `titleFont` and `bodyFont` are separate from color,
                     // so they should be added on their own line after the existing properties,
                     // with a comma separating the last property above them.
                     titleFont: { weight: 'bold' }, // Correctly placed
                     bodyFont: { weight: 'bold' },  // Correctly placed
                     callbacks: {
                         label: function(context) {
                             let label = context.dataset.label || '';
                             if (label) {
                                 label += ': ';
                             }
                             label += context.raw + ' families';
                             return label;
                         }
                     }
                 }
             }
         }
     });
     noFamilyDataMessage.style.display = 'none'; // Hide message if graph is shown
 } else {
     familyChartCanvas.style.display = 'none'; // Hide canvas if no data
     noFamilyDataMessage.style.display = 'block'; // Show message if no data
 }


    // --- Monthly Contributions Chart ---
    const months = JSON.parse('{{ months|safe }}');
    const contributions = JSON.parse('{{ contributions|safe }}');

    const monthlyContributionsCanvas = document.getElementById("monthlyContributionsChart");
    const noContributionsDataMessage = document.getElementById("noContributionsDataMessage");

    if (months.length > 0 && contributions.length > 0 && contributions.some(amount => amount > 0)) {
        new Chart(monthlyContributionsCanvas, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Total Contributions (â‚±)',
                    data: contributions,
                    borderColor: chartFixedColors.accent, // Fixed accent color
                    backgroundColor: chartFixedColors.accent.replace('1)', '0.2)'), // Fixed accent color with transparency
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Amount (â‚±)',
                            color: chartFixedColors.labelColor,
                            font: {weight: 'bold' }// Bold label // Fixed label color
                        },
                        ticks: {
                            color: chartFixedColors.labelColor,
                            font: {weight: 'bold' }// Bold label // Fixed tick color
                        },
                        grid: {
                            color: chartFixedColors.gridColor,
                            font: {weight: 'bold' }// Bold label // Fixed grid color
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month',
                            color: chartFixedColors.labelColor,
                            font: {weight: 'bold' }// Bold label // Fixed label color
                        },
                        ticks: {
                            color: chartFixedColors.labelColor,
                           
                        },
                        grid: {
                            color: chartFixedColors.gridColor ,
                            font: {weight: 'bold' }// Bold label// Fixed grid color
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            color: chartFixedColors.labelColor,
                            font: {weight: 'bold' }// Bold label // Fixed label color
                        }
                    },
                    tooltip: {
                        backgroundColor: chartFixedColors.tooltipBackgroundColor, // Fixed tooltip background
                        borderColor: chartFixedColors.tooltipBorderColor, // Fixed tooltip border
                        borderWidth: 1,
                        titleColor: chartFixedColors.tooltipLabelColor, // Fixed tooltip title color
                        bodyColor: chartFixedColors.tooltipLabelColor, // Fixed tooltip body color
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += 'â‚± ' + context.raw.toFixed(2);
                                return label;
                            }
                        }
                    }
                }
            }
        });
        noContributionsDataMessage.style.display = 'none'; // Hide message if graph is shown
    } else {
        monthlyContributionsCanvas.style.display = 'none'; // Hide canvas if no data
        noContributionsDataMessage.style.display = 'block'; // Show message if no data
    }
</script>
{% endblock content %}