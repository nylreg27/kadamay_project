{# payment_create.html #}
{% extends 'base.html' %}
{% block title %}Create New Payment{% endblock %}

{% block content %}
{# Now, include the partial form template here #}
{% include 'payment/payment_form.html' %} 
{% endblock %}

{% block extra_js %}
{{ block.super }} {# This ensures any parent extra_js content (from base.html) is also included #}
{# Move the entire <script> block from payment_form.html here #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // No need for feather.replace() here if it's already in base.html's DOMContentLoaded
        // You only need it once per page load.

        const selectAllCheckbox = document.getElementById('selectAllMembers');
        const memberSelectCheckboxes = document.querySelectorAll('.member-select-checkbox');
        const ledgerAmountInput = document.getElementById('id_amount');
        const familyAmountDisplay = document.getElementById('family_amount_display');
        const contributionTypeSelect = document.getElementById('id_contribution_type');
        const updateLedgerAmountButton = document.getElementById('updateLedgerAmount');

        let baseContributionAmount = 0;

        async function fetchContributionTypeAmount(contributionTypeId) {
            if (!contributionTypeId) {
                baseContributionAmount = 0;
                return;
            }
            try {
                const response = await fetch(`/api/contribution-types/${contributionTypeId}/`);
                if (!response.ok) {
                    console.error('Failed to fetch contribution type amount');
                    baseContributionAmount = 0;
                    return;
                }
                const data = await response.json();
                baseContributionAmount = parseFloat(data.amount || 0);
                console.log('Base contribution amount:', baseContributionAmount);
                calculateAndDisplayAmounts();
            } catch (error) {
                console.error('Error fetching contribution type amount:', error);
                baseContributionAmount = 0;
            }
        }

        function calculateAndDisplayAmounts() {
            let selectedMembersCount = 0;
            memberSelectCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedMembersCount++;
                }
            });

            const calculatedFamilyAmount = baseContributionAmount;
            familyAmountDisplay.value = calculatedFamilyAmount.toFixed(2);

            if (selectedMembersCount > 0) {
                ledgerAmountInput.value = (calculatedFamilyAmount * selectedMembersCount).toFixed(2);
            } else {
                // If no members are selected, default to base amount if payment is for the individual, or 0.
                // This logic depends on whether a payment without selected members means it's for the 'payee' only.
                if (baseContributionAmount > 0) {
                    ledgerAmountInput.value = baseContributionAmount.toFixed(2);
                } else {
                    ledgerAmountInput.value = '0.00';
                }
            }
        }

        // Event Listeners for payment form logic
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                memberSelectCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                calculateAndDisplayAmounts();
            });
        }

        memberSelectCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', calculateAndDisplayAmounts);
        });

        if (contributionTypeSelect) {
            contributionTypeSelect.addEventListener('change', function() {
                fetchContributionTypeAmount(this.value);
            });
        }

        if (updateLedgerAmountButton) {
            updateLedgerAmountButton.addEventListener('click', calculateAndDisplayAmounts);
        }

        // Initial fetch and calculation on page load
        if (contributionTypeSelect && contributionTypeSelect.value) {
            fetchContributionTypeAmount(contributionTypeSelect.value);
        } else {
            calculateAndDisplayAmounts(); // Run calculation even if no initial type is selected
        }
    });
</script>
{% endblock %}