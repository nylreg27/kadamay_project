{# apps/payment/templates/payment/payment_form.html #}
{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %} 

{% block title %}
    {{ page_title }} - Kadamay Mortuary System
{% endblock %}

{% block extra_css %}
<style>
    /* Card styles for a subtle lift and shadow */
    .card {
        transition: all 0.2s ease-in-out;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border-radius: 0.75rem; /* Slightly more rounded */
        overflow: hidden; /* Ensures shadows look good */
    }
    .card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Stronger hover shadow */
        transform: translateY(-3px); /* Subtle lift effect */
    }
    /* Style for individual family member items in the list */
    .family-member-item {
        transition: background-color 0.15s ease-in-out, transform 0.15s ease-in-out;
        border-radius: 0.5rem; /* Rounded corners for list items */
        margin-bottom: 0.25rem; /* Small spacing between items */
    }
    .family-member-item:hover {
        background-color: theme('colors.base-300'); /* Adjusted hover background for dark mode */
        transform: translateX(4px); /* Slight slide on hover */
    }
    .family-member-item:last-child {
        margin-bottom: 0; /* No margin on last item */
    }
    /* Highlight for the primary payer information card */
    .highlight-card {
        border-left: 6px solid theme('colors.blue.500'); /* Thicker, more prominent border */
        padding-left: 1.5rem; /* Adjust padding for border */
    }
    /* Scrollable container for family members list */
    .scroll-container {
        max-height: 45vh; /* Slightly more height */
        overflow-y: auto;
        border: 1px solid theme('colors.base-content / 15%'); /* Slightly darker border */
        border-radius: 0.75rem; /* More rounded container */
        background-color: theme('colors.base-200'); /* Background for scrollable area */
        padding: 0.5rem; /* Internal padding */
    }
    /* Custom scrollbar styles for better aesthetics */
    .scroll-container::-webkit-scrollbar {
        width: 10px; /* Wider scrollbar */
    }
    .scroll-container::-webkit-scrollbar-thumb {
        background-color: theme('colors.primary'); /* Primary color thumb */
        border-radius: 5px;
        border: 2px solid theme('colors.base-200'); /* Border to make it float */
    }
    .scroll-container::-webkit-scrollbar-track {
        background-color: theme('colors.base-300'); /* Darker track */
        border-radius: 5px;
    }

    /* Input and Select styling for consistent look */
    .input, .select, .textarea {
        border-width: 1px;
        border-color: theme('colors.base-content / 20%');
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .input:focus, .select:focus, .textarea:focus {
        border-color: theme('colors.primary');
        box-shadow: 0 0 0 2px theme('colors.primary / 30%');
        outline: none; /* Remove default outline */
    }
    /* DaisyUI checkbox specific styling */
    .checkbox {
        border-width: 2px;
        border-color: theme('colors.base-content / 40%');
        transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    }
    .checkbox-primary:checked {
        background-color: theme('colors.primary');
        border-color: theme('colors.primary');
    }
    /* Text color for placeholder */
    .input::placeholder, .textarea::placeholder {
        color: theme('colors.base-content / 50%');
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8"> {# Increased vertical padding #}
    <div class="flex justify-between items-center mb-8"> {# Increased bottom margin #}
        <div>
            <h1 class="text-3xl font-extrabold text-base-content"> {# Larger title #}
                {{ page_title }}
            </h1>
            <p class="text-base-content/80 text-md mt-2">Record new payments and contributions with ease.</p> {# Slightly larger text #}
        </div>
        <div class="flex space-x-3"> {# Increased spacing #}
            <a href="{% url 'payment:payment_list' %}" class="btn btn-md btn-outline btn-neutral flex items-center gap-2 rounded-lg font-semibold"> {# Larger buttons, rounded #}
                <i data-feather="arrow-left" class="w-5 h-5"></i>
                Back to Payments
            </a>
        </div>
    </div>

    {# Display Django messages (success, error, etc.) #}
    {% if messages %}
        <div class="mb-6"> {# Increased bottom margin #}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} shadow-lg mb-3 rounded-lg text-sm"> {# Larger shadow, rounded #}
                    <div>
                        {# Dynamic icon based on message tag #}
                        {% if message.tags == 'success' %}
                            <i data-feather="check-circle" class="w-6 h-6"></i> {# Larger icon #}
                        {% elif message.tags == 'error' %}
                            <i data-feather="alert-circle" class="w-6 h-6"></i> {# Larger icon #}
                        {% else %}
                            <i data-feather="info" class="w-6 h-6"></i> {# Larger icon #}
                        {% endif %}
                        <span class="font-medium">{{ message }}</span> {# Slightly bolder message text #}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {# FIXED: Pass individual_id to the add_payment URL #}
    <form method="post" action="" class="space-y-8" id="paymentForm">
        {% csrf_token %}

        {# Hidden input to store selected family member IDs for submission #}
        <input type="hidden" name="selected_members_ids" id="selectedMembersIdsInput" value="">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8"> {# Increased gap between columns #}
            <div class="flex flex-col gap-6"> {# Increased vertical spacing #}
                {# Payer Information Card #}
                <div class="card bg-base-100 rounded-lg p-6 highlight-card"> {# Increased padding #}
                    <h2 class="text-xl font-bold text-base-content mb-4 flex items-center gap-3"> {# Larger title, increased gap #}
                        <i data-feather="user" class="w-5 h-5 text-blue-500"></i>
                        Payer Information
                    </h2>
                    
                    <div class="space-y-4"> {# Increased spacing #}
                        <div>
                            <label for="{{ form.individual.id_for_label }}" class="block text-sm font-medium text-base-content mb-2"> {# Slightly larger label #}
                                Payee (Head of Family)
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                {% render_field form.individual class="select select-bordered w-full text-base-content bg-base-200 text-base py-2" %} {# Larger text, more padding #}
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"> {# Adjusted padding #}
                                    <i data-feather="chevron-down" class="w-4 h-4 text-base-content/50"></i> {# Larger icon #}
                                </div>
                            </div>
                            {% if form.individual.errors %}
                                <p class="text-red-600 text-xs mt-1">{{ form.individual.errors }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> {# Increased gap #}
                            <div>
                                <label for="{{ form.contribution_type.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                    Contribution Type
                                    <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    {% render_field form.contribution_type class="select select-bordered w-full text-base-content bg-base-200 text-base py-2" %}
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <i data-feather="chevron-down" class="w-4 h-4 text-base-content/50"></i>
                                    </div>
                                </div>
                                {% if form.contribution_type.errors %}
                                    <p class="text-red-600 text-xs mt-1">{{ form.contribution_type.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.payment_method.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                    Payment Method
                                    <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    {% render_field form.payment_method class="select select-bordered w-full text-base-content bg-base-200 text-base py-2" %}
                                    <div class="absolute inset-y="0" right="0" flex items-center pr-3 pointer-events-none">
                                        <i data-feather="chevron-down" class="w-4 h-4 text-base-content/50"></i>
                                    </div>
                                </div>
                                {% if form.payment_method.errors %}
                                    <p class="text-red-600 text-xs mt-1">{{ form.payment_method.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# Payment Details Card #}
                <div class="card bg-base-100 rounded-lg p-6"> {# Increased padding #}
                    <h2 class="text-xl font-bold text-base-content mb-4 flex items-center gap-3">
                        <i data-feather="credit-card" class="w-5 h-5 text-green-500"></i>
                        Payment Details
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> {# Increased gap #}
                        <div>
                            <label for="{{ form.receipt_number.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                Receipt Number
                                <span class="text-red-500">*</span>
                            </label>
                            {# Conditional rendering for readonly/editable receipt number #}
                            {% if user.is_superuser %}
                                {# Superusers can manually input or override auto-generated #}
                                {% render_field form.receipt_number class="input input-bordered w-full text-base-content bg-base-200 text-base py-2" placeholder="Auto-generated or Manual Input" %}
                            {% else %}
                                {# Non-superusers will have it readonly and auto-generated #}
                                {% render_field form.receipt_number class="input input-bordered w-full text-base-content bg-base-200 text-base py-2 cursor-not-allowed" readonly="true" placeholder="Auto-generated" %}
                            {% endif %}
                            {% if form.receipt_number.errors %}
                                <p class="text-red-600 text-xs mt-1">{{ form.receipt_number.errors }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.date_paid.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                Date Paid
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                {% render_field form.date_paid type="date" class="input input-bordered w-full text-base-content bg-base-200 text-base py-2" %}
                                <div class="absolute inset-y="0" right="0" flex items-center pr-3 pointer-events-none">
                                    <i data-feather="calendar" class="w-4 h-4 text-base-content/50"></i>
                                </div>
                            </div>
                            {% if form.date_paid.errors %}
                                <p class="text-red-600 text-xs mt-1">{{ form.date_paid.errors }}</p>
                            {% endif %}
                        </div>
                    </div>

                    {# NEW FIELD: is_legacy_record checkbox #}
                    <div class="form-control mt-4"> {# Increased top margin #}
                        <label class="label cursor-pointer justify-start">
                            {% render_field form.is_legacy_record class="checkbox checkbox-primary mr-3" %} {# Larger margin #}
                            <span class="label-text text-base-content text-base font-medium">Old Record (No Original Receipt)</span> {# Larger text, bolder #}
                        </label>
                        {% if form.is_legacy_record.errors %}
                            <p class="text-red-600 text-xs mt-1">{{ form.is_legacy_record.errors }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="mt-4"> {# Increased top margin #}
                        <label for="{{ form.deceased_member.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                            Remarks (Deceased Member) </label>
                        <div class="relative">
                            {% render_field form.deceased_member class="select select-bordered w-full text-base-content bg-base-200 text-base py-2" %}
                            <div class="absolute inset-y="0" right="0" flex items-center pr-3 pointer-events-none">
                                <i data-feather="chevron-down" class="w-4 h-4 text-base-content/50"></i>
                            </div>
                        </div>
                        {% if form.deceased_member.errors %}
                            <p class="text-red-600 text-xs mt-1">{{ form.deceased_member.errors }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-6"> {# Increased vertical spacing #}
                {# Family Details Card #}
                <div class="card bg-base-100 rounded-lg p-6"> {# Increased padding #}
                    <h2 class="text-xl font-bold text-base-content mb-4 flex items-center gap-3">
                        <i data-feather="users" class="w-5 h-5 text-purple-500"></i>
                        Family Details
                    </h2>
                    
                    <div class="bg-primary/15 rounded-lg p-4 mb-4"> {# Slightly darker background, more padding, rounded #}
                        <h3 class="font-bold text-primary text-center text-md" id="familyNameLabel"> {# Larger text #}
                            Please Select a Payee
                        </h3>
                    </div>
                    
                    <div class="space-y-4"> {# Increased spacing #}
                        <div class="bg-base-200 p-4 rounded-lg"> {# More padding, rounded #}
                            <div class="flex justify-between items-center mb-3"> {# Increased margin #}
                                <h4 class="font-medium text-base-content text-md">Family Members for Contribution</h4> {# Larger text #}
                                <div class="flex items-center">
                                    <input type="checkbox" id="selectAllFamilyMembers" class="checkbox checkbox-sm checkbox-primary mr-2"> {# Added primary color #}
                                    <label for="selectAllFamilyMembers" class="ml-1 text-sm text-base-content">Select All</label> {# Adjusted margin #}
                                </div>
                            </div>
                            
                            <div class="scroll-container">
                                <div id="familyMembersList" class="space-y-2"> {# Increased spacing between items #}
                                    {# Placeholder content for when no payee is selected #}
                                    <div class="text-center py-8 text-base-content/50"> {# More padding #}
                                        <i data-feather="users" class="w-12 h-12 mx-auto mb-2"></i> {# Larger icon #}
                                        <p class="mt-2 text-md">Select the payee to view family members</p> {# Larger text #}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {# Amount Calculation Card #}
                <div class="card bg-base-100 rounded-lg p-6"> {# Increased padding #}
                    <h2 class="text-xl font-bold text-base-content mb-4 flex items-center gap-3">
                        <i data-feather="dollar-sign" class="w-5 h-5 text-yellow-500"></i>
                        Amount Calculation
                    </h2>
                    
                    <div class="bg-base-200 p-4 rounded-lg mb-4"> {# More padding, rounded, increased margin #}
                        <div class="grid grid-cols-2 gap-4"> {# Increased gap #}
                            <div class="text-center">
                                <p class="text-sm text-base-content/70">Selected Members</p> 
                                <p id="selectedMembersCount" class="text-2xl font-extrabold text-blue-600">0</p> {# Larger text, extra bold #}
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-base-content/70">Per Member</p> 
                                <p id="perMemberAmount" class="text-2xl font-extrabold text-green-600">₱0.00</p> {# Larger text, extra bold #}
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4 mt-3">
                        <div>
                            <label class="block text-sm font-medium text-base-content mb-2">
                                Family Contribution Amount (Calculated)
                            </label>
                            <div class="relative">
                                <input type="text" id="family_amount_display"
                                            class="input input-bordered w-full text-base font-bold text-green-500 bg-base-200 py-2"
                                            value="0.00" readonly>
                                <div class="absolute inset-y="0" right="0" flex items-center pr-3 pointer-events-none">
                                    <i data-feather="dollar-sign" class="w-4 h-4 text-base-content/50"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="{{ form.amount.id_for_label }}" class="block text-sm font-medium text-base-content mb-2">
                                Total Payment Amount
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                {# Using render_field #}
                                <input type="number" step="0.01" name="{{ form.amount.name }}" id="{{ form.amount.id_for_label }}"
                                    class="input input-bordered w-full text-base-content bg-base-200 text-base py-2 {% if form.amount.errors %}input-error{% endif %}"
                                    value="{{ form.amount.value|default_if_none:'0.00' }}">
                                <div class="absolute inset-y="0" right="0" flex items-center pr-3 pointer-events-none">
                                    <i data-feather="dollar-sign" class="w-4 h-4 text-base-content/50"></i>
                                </div>
                            </div>
                            {% if form.amount.errors %}
                                <p class="text-red-600 text-xs mt-1">{{ form.amount.errors }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-base-content/15"> {# Increased spacing, top margin, thicker border #}
            <button type="reset" class="btn btn-md btn-outline btn-neutral flex items-center gap-2 rounded-lg font-semibold">
                <i data-feather="refresh-ccw" class="w-5 h-5"></i>
                Reset Form
            </button>
            <button type="submit" class="btn btn-md btn-success flex items-center gap-2 rounded-lg font-semibold">
                <i data-feather="save" class="w-5 h-5"></i>
                Save Payment Record
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{# Load Feather Icons library #}
<script src="https://unpkg.com/feather-icons"></script> 

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Feather icons
        if (typeof feather !== 'undefined') {
            feather.replace(); 
        } else {
            console.error("Feather icons library not loaded.");
        }
        
        // --- Element References ---
        const payeeSelect = document.getElementById('id_individual');
        const familyNameLabel = document.getElementById('familyNameLabel');
        const familyMembersList = document.getElementById('familyMembersList');
        const selectAllCheckbox = document.getElementById('selectAllFamilyMembers');
        const familyAmountDisplay = document.getElementById('family_amount_display');
        const mainAmountInput = document.getElementById('id_amount');
        const contributionTypeSelect = document.getElementById('id_contribution_type');
        const selectedMembersCount = document.getElementById('selectedMembersCount');
        const perMemberAmount = document.getElementById('perMemberAmount');
        const selectedMembersIdsInput = document.getElementById('selectedMembersIdsInput'); // Hidden input for selected member IDs
        const receiptNumberInput = document.getElementById('id_receipt_number'); 
        const isLegacyRecordCheckbox = document.getElementById('id_is_legacy_record'); 
        const isSuperuser = {{ user.is_superuser|yesno:"true,false" }}; // Pass superuser status from Django context

        let defaultContributionAmount = 0; // Stores the per-member contribution amount

        // --- Utility Functions ---

        /**
         * Updates the hidden input field with a JSON string of selected member IDs.
         * This ensures selected members are sent with the form submission.
         */
        function updateSelectedMembersIdsInput() {
            const selectedIds = Array.from(document.querySelectorAll('.member-checkbox:checked'))
                                     .map(checkbox => checkbox.value);
            selectedMembersIdsInput.value = JSON.stringify(selectedIds);
        }

        /**
         * Manages the state of the receipt_number input field based on the isLegacyRecord checkbox and superuser status.
         */
        function handleReceiptNumberState() {
            if (!receiptNumberInput || !isLegacyRecordCheckbox) {
                console.error("Receipt Number input or Legacy Record checkbox not found.");
                return;
            }

            if (isLegacyRecordCheckbox.checked) {
                // If legacy, clear value and make it disabled/readonly
                receiptNumberInput.value = ''; 
                receiptNumberInput.setAttribute('readonly', 'true');
                receiptNumberInput.setAttribute('disabled', 'true'); 
                receiptNumberInput.setAttribute('placeholder', 'N/A for Old Records');
                receiptNumberInput.classList.add('bg-base-300', 'cursor-not-allowed'); 
            } else if (isSuperuser) {
                // If not legacy AND is superuser, make it editable
                receiptNumberInput.removeAttribute('readonly');
                receiptNumberInput.removeAttribute('disabled');
                receiptNumberInput.setAttribute('placeholder', 'Enter manually or leave blank for auto-gen');
                receiptNumberInput.classList.remove('bg-base-300', 'cursor-not-allowed'); 
            } else {
                // If not legacy AND not superuser, keep it readonly for auto-generation
                receiptNumberInput.setAttribute('readonly', 'true');
                receiptNumberInput.removeAttribute('disabled'); // Ensure it's not disabled
                receiptNumberInput.setAttribute('placeholder', 'Auto-generated');
                receiptNumberInput.classList.add('bg-base-300', 'cursor-not-allowed'); 
            }
            // Ensure any error class is removed if the field state changes
            receiptNumberInput.classList.remove('input-error');
        }

        /**
         * Fetches family details and populates the family members list
         * based on the selected individual (payee).
         * @param {string} individualId - The ID of the selected individual.
         */
        async function populateFamilyAndMembers(individualId) {
            // Show loading state
            familyMembersList.innerHTML = `
                <div class="text-center py-6">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                    <p class="mt-2 text-base-content/70">Loading family data...</p>
                </div>`;
            
            familyNameLabel.textContent = 'Family details loading...';
            resetCalculationDisplays(); // Reset counts and amounts

            if (!individualId) {
                // Display placeholder if no individual is selected
                familyMembersList.innerHTML = `
                    <div class="text-center py-6 text-base-content/50">
                        <i data-feather="users" class="w-10 h-10 mx-auto"></i>
                        <p class="mt-1 text-sm">Select a payee to view family members</p>
                    </div>`;
                familyNameLabel.textContent = 'Please select a Payee';
                if (typeof feather !== 'undefined') feather.replace();
                updateSelectedMembersIdsInput(); // Clear hidden input
                return;
            }

            try {
                const response = await fetch(`/payment/api/individual/${individualId}/family_details/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Update family name label
                familyNameLabel.textContent = data.family_name || 'No Family Assigned';
                familyNameLabel.classList.toggle('text-red-500', !data.family_name); // Highlight if no family

                // Populate Family Members checkboxes
                familyMembersList.innerHTML = ''; // Clear previous list
                if (data.family_members && data.family_members.length > 0) {
                    data.family_members.forEach(member => {
                        const memberDiv = document.createElement('div');
                        memberDiv.className = 'family-member-item flex items-center p-3 border-b border-base-content/10 last:border-b-0 cursor-pointer'; /* Added cursor-pointer */
                        memberDiv.innerHTML = `
                            <div class="flex items-center w-full">
                                <input type="checkbox" name="family_members_for_contribution" value="${member.id}" 
                                    id="member_${member.id}" class="checkbox checkbox-sm checkbox-primary mr-3 member-checkbox">
                                <label for="member_${member.id}" class="flex-1 min-w-0 cursor-pointer">
                                    <div class="font-medium text-base text-base-content truncate">${member.full_name}</div>
                                    <div class="flex text-xs text-base-content/70 mt-0.5">
                                        <span class="mr-2">${member.status || 'N/A'}</span>
                                        <span>${member.relationship || 'N/A'}</span>
                                    </div>
                                </label>
                            </div>
                        `;
                        familyMembersList.appendChild(memberDiv);
                        
                        // Add event listener to each new member checkbox
                        const checkbox = memberDiv.querySelector('.member-checkbox');
                        checkbox.addEventListener('change', () => {
                            calculateFamilyAmount();
                            updateSelectedMembersIdsInput();
                            // If any individual checkbox is unchecked, uncheck the "Select All"
                            if (!checkbox.checked && selectAllCheckbox.checked) {
                                selectAllCheckbox.checked = false;
                            }
                        });
                    });

                    // --- ADDED LOGIC FOR PAYEE ---
                    // Auto-check the payee's checkbox if found in the list
                    const payeeCheckbox = document.getElementById(`member_${individualId}`);
                    if (payeeCheckbox) {
                        payeeCheckbox.checked = true;
                    }
                    // --- END ADDED LOGIC ---

                } else {
                    // Display message if no family members found
                    familyMembersList.innerHTML = `
                        <div class="text-center py-6 text-base-content/50">
                            <i data-feather="user-x" class="w-10 h-10 mx-auto"></i>
                            <p class="mt-1 text-sm">No family members found for this payee</p>
                        </div>`;
                }
                
                calculateFamilyAmount(); // Initial calculation after populating members
                updateSelectedMembersIdsInput(); // Update hidden input on successful load
                if (typeof feather !== 'undefined') feather.replace(); // Re-render icons after adding new elements

            } catch (error) {
                console.error('Error fetching family data:', error);
                familyMembersList.innerHTML = `
                    <div class="alert alert-error shadow-md text-sm">
                        <div>
                            <i data-feather="alert-triangle" class="w-5 h-5"></i>
                            <span>Error loading family data. Please try again.</span>
                        </div>
                    </div>`;
                familyNameLabel.textContent = 'Error loading family data!';
                if (typeof feather !== 'undefined') feather.replace();
            }
        }

        function calculateFamilyAmount() {
            const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
            selectedMembersCount.textContent = selectedCheckboxes.length;
            
            const calculatedAmount = selectedCheckboxes.length * defaultContributionAmount;
            familyAmountDisplay.value = calculatedAmount.toFixed(2);

            // Automatically set the main amount input if it's currently zero
            // or if it matches the previously calculated family amount.
            // This allows manual override without being constantly reset.
            const currentMainAmount = parseFloat(mainAmountInput.value || 0);
            if (currentMainAmount === 0 || currentMainAmount.toFixed(2) === parseFloat(calculatedAmount.toFixed(2)).toFixed(2)) {
                mainAmountInput.value = calculatedAmount.toFixed(2);
            }
        }

        async function getContributionAmount(contributionTypeId) {
            if (!contributionTypeId) {
                defaultContributionAmount = 0;
                perMemberAmount.textContent = '₱0.00';
                calculateFamilyAmount();
                return;
            }
            
            try {
                const response = await fetch(`/payment/api/contribution_type/${contributionTypeId}/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                defaultContributionAmount = parseFloat(data.amount || 0);
                perMemberAmount.textContent = `₱${defaultContributionAmount.toFixed(2)}`;
                calculateFamilyAmount(); // Recalculate family amount with new per-member rate
                
            } catch (error) {
                console.error('Error fetching contribution amount:', error);
                defaultContributionAmount = 0;
                perMemberAmount.textContent = '₱0.00';
                calculateFamilyAmount();
            }
        }

        function resetCalculationDisplays() {
            selectedMembersCount.textContent = '0';
            perMemberAmount.textContent = '₱0.00';
            familyAmountDisplay.value = '0.00';
            selectAllCheckbox.checked = false;
        }

        // --- Event Listeners ---

        // Listen for changes on the Payee select dropdown
        payeeSelect.addEventListener('change', function() {
            populateFamilyAndMembers(this.value);
        });

        // Listen for changes on the "Select All" family members checkbox
        selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.member-checkbox').forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            calculateFamilyAmount(); // Recalculate total amount
            updateSelectedMembersIdsInput(); // Update hidden input
        });

        // Listen for changes on the Contribution Type select dropdown
        contributionTypeSelect.addEventListener('change', function() {
            getContributionAmount(this.value);
        });

        // Listen for manual input on the total payment amount field
        mainAmountInput.addEventListener('input', function() {
            // Allow only numbers and a single decimal point
            this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');
            if (this.value.startsWith('.')) this.value = '0' + this.value;
            // Handle multiple decimal points to ensure only one
            const parts = this.value.split('.');
            if (parts.length > 2) {
                this.value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Remove error styling if input becomes valid
            if (parseFloat(this.value) > 0 || this.value === '') { // Allow empty during typing
                this.classList.remove('input-error');
            }
        });

        // Event Listener for isLegacyRecordCheckbox
        if (isLegacyRecordCheckbox) {
            isLegacyRecordCheckbox.addEventListener('change', handleReceiptNumberState);
        }

        // Form reset event handling
        document.getElementById('paymentForm').addEventListener('reset', function() {
            // Reset payee and contribution type selects to default state
            payeeSelect.value = ''; 
            contributionTypeSelect.value = '';
            
            // Trigger repopulation and recalculation to reset dynamic sections
            populateFamilyAndMembers(''); 
            getContributionAmount('');
            mainAmountInput.classList.remove('input-error'); // Clear error class
            // Reset default contribution amount explicitly
            defaultContributionAmount = 0; 
            perMemberAmount.textContent = '₱0.00';
            familyAmountDisplay.value = '0.00';
            mainAmountInput.value = '0.00'; // Ensure main amount is reset
            updateSelectedMembersIdsInput(); // Clear hidden input
            
            // Reset receipt number and legacy checkbox on form reset
            if (receiptNumberInput) receiptNumberInput.value = ''; 
            if (isLegacyRecordCheckbox) isLegacyRecordCheckbox.checked = false;
            handleReceiptNumberState(); // Re-apply initial state for receipt number
        });

        // Form submission handling to ensure amount is valid
        document.getElementById('paymentForm').addEventListener('submit', function(event) {
            const amount = parseFloat(mainAmountInput.value);
            // Check if amount is not a number, or is zero/negative
            if (isNaN(amount) || amount <= 0) {
                event.preventDefault(); // Prevent form submission
                mainAmountInput.classList.add('input-error'); // Add error styling
                // Use a more user-friendly modal/toast for feedback instead of alert in production
                // alert('Please enter a valid payment amount greater than zero.'); // Old alert
                
                // --- NEW: Using a custom modal/toast for feedback instead of alert ---
                const errorMessage = 'Please enter a valid payment amount greater than zero.';
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-error shadow-lg mb-3 rounded-lg text-sm';
                errorDiv.innerHTML = `
                    <div>
                        <i data-feather="alert-circle" class="w-6 h-6"></i>
                        <span class="font-medium">${errorMessage}</span>
                    </div>
                `;
                // Insert the error message before the form
                document.querySelector('.container.mx-auto.px-4.py-8').prepend(errorDiv);
                // Automatically remove the message after some time
                setTimeout(() => errorDiv.remove(), 5000); // Remove after 5 seconds
                if (typeof feather !== 'undefined') feather.replace(); // Ensure icon is rendered
                // --- END NEW ---

                mainAmountInput.focus(); // Focus on the problematic field
            }
        });

        // --- Initialization on Load ---
        const initializeForm = () => {
            // Initial state setup for receipt number based on superuser status
            // This ensures it's correctly editable/readonly on page load
            handleReceiptNumberState();

            // If payee is pre-selected (e.g., on form error with initial data)
            if (payeeSelect.value) {
                populateFamilyAndMembers(payeeSelect.value);
            } else {
                // If no payee selected, ensure placeholder is displayed
                familyNameLabel.textContent = 'Please select a Payee';
                if (familyMembersList) {
                    familyMembersList.innerHTML = `
                        <div class="text-center py-6 text-base-content/50">
                            <i data-feather="users" class="w-10 h-10 mx-auto"></i>
                            <p class="mt-1 text-sm">Select a payee to view family members</p>
                        </div>`;
                }
            }

            // If contribution type is pre-selected
            if (contributionTypeSelect.value) {
                getContributionAmount(contributionTypeSelect.value);
            }
            
            feather.replace(); // Ensure all icons are rendered
        };

        // Use a small timeout to ensure all form elements are fully rendered by Django
        // This is a common practice for dynamic elements to avoid race conditions.
        setTimeout(initializeForm, 50);

    }); // End DOMContentLoaded
</script>
{% endblock extra_js %}
